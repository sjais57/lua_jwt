def flatten_models(node, allowed_model_list, ancestry=None, model_info_map=None):
    if ancestry is None:
        ancestry = {}
    if model_info_map is None:
        model_info_map = {}

    if isinstance(node, dict):
        # Leaf node: unique_model_name means this is a model config
        if "unique_model_name" in node:
            unique_model_name = node.get("unique_model_name", "")
            if allowed_model_list and unique_model_name not in allowed_model_list:
                return model_info_map
            framework_entry = {
                "supported_framework": node.get("supported_framework", ""),
                "tasks": str(node.get("tasks", "")) if node.get("tasks") is not None else "",
                "script_name": node.get("script_name", ""),
                "hpc_model_name": node.get("hpc_model_name", "")
            }
            if unique_model_name not in model_info_map:
                model_info_map[unique_model_name] = {
                    "model_name": unique_model_name,
                    **ancestry,
                    "frameworks": []
                }
            model_info_map[unique_model_name]["frameworks"].append(framework_entry)
        else:
            # Not a config leaf: walk all dict items
            for key, value in node.items():
                new_ancestry = ancestry.copy()
                # Store 'name' field in ancestry for all hierarchy levels
                if key in ("model_type", "model_family", "model_collection", "variants", "variant"):
                    if isinstance(node, dict) and "name" in node:
                        new_ancestry[key] = node.get("name", "")
                # Recursively process lists/dicts
                if isinstance(value, (dict, list)):
                    flatten_models(value, allowed_model_list, new_ancestry, model_info_map)

    elif isinstance(node, list):
        # For lists, just process each item
        for item in node:
            flatten_models(item, allowed_model_list, ancestry, model_info_map)

    return model_info_map
