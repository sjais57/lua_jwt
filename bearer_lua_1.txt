local http = require "resty.http"

local httpc = http.new()
local res, err = httpc:request_uri("https://keycloak.example.com/auth/realms/your-realm/protocol/openid-connect/token", {
    method = "POST",
    body = ngx.encode_args({
        client_id = "api-client",
        client_secret = "your-client-secret",
        grant_type = "client_credentials"
    }),
    headers = {
        ["Content-Type"] = "application/x-www-form-urlencoded"
    },
    ssl_verify = false
})

if not res then
    print("HTTP request failed: ", err)
    return
end

if res.status ~= 200 then
    print("HTTP response failed. Status: ", res.status, " Response: ", res.body)
    return
end

local cjson = require "cjson.safe"
local body, decode_err = cjson.decode(res.body)
if not body or not body.access_token then
    print("JSON decode failed: ", decode_err or "missing access_token in response body")
    print("Response body was: ", res.body)
    return
end

print("Successfully fetched token: ", body.access_token)
