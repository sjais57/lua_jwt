curl -X PUT 'http://<APISIX_ADMIN_IP>:<PORT>/apisix/admin/routes/1' \
-H 'X-API-KEY: <YOUR_API_KEY>' \
-H 'Content-Type: application/json' \
-d '{
  "uri": "/get-config-names",
  "plugins": {
    "jwt-auth": {
      "key": "your_key_name",
      "secret": "your_jwt_secret",
      "payload": {
        "iss": "your_issuer"
      }
    },
    "serverless-pre-function": {
      "phase": "rewrite",
      "functions": [
        "return function(conf, ctx)
            local jwt = require('resty.jwt')
            local token = ctx.var.http_authorization and ctx.var.http_authorization:match('Bearer%s+(.+)')
            if not token then
                return 401, {message = 'Missing JWT token'}
            end
            
            local jwt_obj = jwt:load_jwt(token)
            if not jwt_obj.valid then
                return 401, {message = 'Invalid JWT token'}
            end
            
            -- Extract configuration names from JWT payload
            local config_names = jwt_obj.payload.config_names or {}
            
            -- Set the config names in header or variable for upstream
            ngx.req.set_header('X-Config-Names', table.concat(config_names, ','))
            ngx.var.config_names = table.concat(config_names, ',')
        end"
      ]
    }
  },
  "upstream": {
    "type": "roundrobin",
    "nodes": {
      "<UPSTREAM_SERVICE>": 1
    }
  }
}'
